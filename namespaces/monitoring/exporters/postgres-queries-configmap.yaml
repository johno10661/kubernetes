apiVersion: v1
data:
  queries.yaml: |
    pg_settings:
      query: "SELECT name, setting::float, unit, short_desc FROM pg_settings WHERE vartype IN ('integer', 'real')"
      master: true
      metrics:
        - name:
            usage: "LABEL"
            description: "Setting name"
        - setting:
            usage: "GAUGE"
            description: "Setting value"
        - unit:
            usage: "LABEL"
            description: "Setting unit"
        - short_desc:
            usage: "LABEL"
            description: "Setting description"

    pg_stat_statements:
      query: |
        SELECT
          queryid,
          calls,
          total_exec_time,
          mean_exec_time,
          rows
        FROM pg_stat_statements
        WHERE queryid IS NOT NULL
        ORDER BY mean_exec_time DESC
        LIMIT 20
      master: true
      metrics:
        - queryid:
            usage: "LABEL"
            description: "Query ID"
        - calls:
            usage: "COUNTER"
            description: "Number of times executed"
        - total_exec_time:
            usage: "COUNTER"
            description: "Total time spent executing"
        - mean_exec_time:
            usage: "GAUGE"
            description: "Mean execution time"
        - rows:
            usage: "COUNTER"
            description: "Total rows returned"

    pg_stat_database:
      query: |
        SELECT
          datname,
          numbackends,
          xact_commit,
          xact_rollback,
          blks_read,
          blks_hit,
          tup_returned,
          tup_fetched,
          tup_inserted,
          tup_updated,
          tup_deleted,
          conflicts,
          temp_files,
          temp_bytes,
          deadlocks
        FROM pg_stat_database
        WHERE datname NOT IN ('template0', 'template1')
      master: true
      metrics:
        - datname:
            usage: "LABEL"
            description: "Database name"
        - numbackends:
            usage: "GAUGE"
            description: "Number of backends"
        - xact_commit:
            usage: "COUNTER"
            description: "Transactions committed"
        - xact_rollback:
            usage: "COUNTER"
            description: "Transactions rolled back"
        - blks_read:
            usage: "COUNTER"
            description: "Blocks read from disk"
        - blks_hit:
            usage: "COUNTER"
            description: "Blocks found in cache"
        - tup_returned:
            usage: "COUNTER"
            description: "Rows returned"
        - tup_fetched:
            usage: "COUNTER"
            description: "Rows fetched"
        - tup_inserted:
            usage: "COUNTER"
            description: "Rows inserted"
        - tup_updated:
            usage: "COUNTER"
            description: "Rows updated"
        - tup_deleted:
            usage: "COUNTER"
            description: "Rows deleted"
        - conflicts:
            usage: "COUNTER"
            description: "Conflicts"
        - temp_files:
            usage: "COUNTER"
            description: "Temporary files created"
        - temp_bytes:
            usage: "COUNTER"
            description: "Temporary bytes written"
        - deadlocks:
            usage: "COUNTER"
            description: "Deadlocks detected"

    pg_stat_bgwriter:
      query: |
        SELECT
          checkpoints_timed,
          checkpoints_req,
          checkpoint_write_time,
          checkpoint_sync_time,
          buffers_checkpoint,
          buffers_clean,
          maxwritten_clean,
          buffers_backend,
          buffers_backend_fsync,
          buffers_alloc
        FROM pg_stat_bgwriter
      master: true
      metrics:
        - checkpoints_timed:
            usage: "COUNTER"
            description: "Scheduled checkpoints"
        - checkpoints_req:
            usage: "COUNTER"
            description: "Requested checkpoints"
        - checkpoint_write_time:
            usage: "COUNTER"
            description: "Time writing checkpoints (ms)"
        - checkpoint_sync_time:
            usage: "COUNTER"
            description: "Time syncing checkpoints (ms)"
        - buffers_checkpoint:
            usage: "COUNTER"
            description: "Buffers written during checkpoints"
        - buffers_clean:
            usage: "COUNTER"
            description: "Buffers written by background writer"
        - maxwritten_clean:
            usage: "COUNTER"
            description: "Background writer stopped by max write count"
        - buffers_backend:
            usage: "COUNTER"
            description: "Buffers written directly by backends"
        - buffers_backend_fsync:
            usage: "COUNTER"
            description: "Times backends executed fsync"
        - buffers_alloc:
            usage: "COUNTER"
            description: "Buffers allocated"
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: postgres-exporter-queries
  namespace: monitoring
